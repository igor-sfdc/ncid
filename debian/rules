#!/usr/bin/make -f
# Sample debian/rules file - for GNU Hello.
# Copyright 1994,1995 by Ian Jackson.
# I hereby give you perpetual unlimited permission to copy,
# modify and relicense this file, provided that you do not remove
# my name from the file itself.  (I assert my moral right of
# paternity under the Copyright, Designs and Patents Act 1988.)
# This file may have to be extensively modified
#
# Modified by John L. Chmielewski to package ncid
# Last Modified Oct 1, 2016

package = ncid
prog    = ncidd

pkg = gateways client mysql mythtv kpopup samba speak

docdir  = usr/share/doc/$(package)

build:
	$(checkdir)
	$(MAKE) ubuntu
	touch build

clean:
	$(checkdir)
	rm -f build
	-$(MAKE) -i distclean
	rm -rf *~ debian/tmp* debian/*~ debian/files* debian/substvars

binary-indep:   checkroot build
	$(checkdir)
# There are no architecture-independent files to be uploaded
# generated by this package.  If there were any they would be
# made here.

binary-arch:    checkroot build
	$(checkdir)
	rm -rf debian/tmp*
	install -d debian/tmp-ncid/DEBIAN debian/tmp-ncid/$(docdir)
	for i in $(pkg); do \
                     install -d debian/tmp-$$i/DEBIAN \
                     debian/tmp-$$i/usr/share/doc/$(package)-$$i; \
                     done
	$(MAKE) \
        prefix=$$(pwd)/debian/tmp-ncid/usr \
        prefix2=$$(pwd)/debian/tmp-ncid \
        prefix3=$$(pwd)/debian/tmp-ncid \
        install install-debian

        # NCID server and support utilities
	install -m 755 debian/postinst debian/prerm debian/postrm \
                       debian/tmp-ncid/DEBIAN
	install -m 644 debian/conffiles debian/tmp-ncid/DEBIAN
	rm -f debian/tmp-ncid/etc/init.d/ncid-* \
          debian/tmp-ncid/etc/ncid/ncid.conf \
          debian/tmp-ncid/usr/bin/ncid \
          debian/tmp-ncid/usr/share/doc/ncid/README.modules \
          debian/tmp-ncid/usr/share/doc/ncid/README.gateways \
          debian/tmp-ncid/usr/share/man/man1/ncid.1 \
          debian/tmp-ncid/usr/share/man/man1/ncid-*.1 \
          debian/tmp-ncid/usr/share/man/man5/ncid.conf.5 \
          debian/tmp-ncid/usr/share/man/man7/ncid-modules.7
	rm -fr debian/tmp-ncid/usr/share/pixmaps debian/tmp-ncid/etc/ncid/conf.d \
           debian/tmp-ncid/usr/share/ncid/modules \
           debian/tmp-ncid/usr/share/ncid/setup
	install -m 644 man/ncid-yearlog.1 debian/tmp-ncid/usr/share/man/man1
	install -m 644 man/ncid-setup.1 debian/tmp-ncid/usr/share/man/man1
	install -m 644 debian/changelog debian/tmp-ncid/$(docdir)/changelog.Debian
	cp -a README VERSION doc/GPL.md \
          doc/NCID-UserManual.md doc/images \
          doc/README.docdir man/README.mandir debian/README.Debian \
          server/README.server logrotate/README.logrotate tools/README.tools \
          debian/tmp-ncid/$(docdir)
	dpkg-shlibdeps debian/tmp-ncid/usr/sbin/ncidd

        # NCID gateways
	install -m 755 debian/prerm-gateways debian/tmp-gateways/DEBIAN
	install -m 755 debian/postrm-gateways debian/tmp-gateways/DEBIAN
	install -m 644 debian/ncid-gateways.conffiles debian/tmp-gateways/DEBIAN
	cd debian/tmp-gateways; mkdir -p etc/init.d etc/ncid usr/bin usr/sbin \
       usr/share/ncid/setup \
       usr/share/man/man1 usr/share/man/man5 usr/share/man/man7 \
       usr/share/man/man8
	install -m 755 setup/ncid-email2ncid-setup \
                   debian/tmp-gateways/usr/share/ncid/setup/.
	mv debian/tmp-ncid/usr/bin/*2ncid debian/tmp-ncid/usr/bin/wct \
       debian/tmp-gateways/usr/bin
	mv debian/tmp-ncid/usr/sbin/sip2ncid debian/tmp-gateways/usr/sbin/.
	mv debian/tmp-ncid/etc/ncid/*2ncid.conf debian/tmp-gateways/etc/ncid
	mv debian/tmp-ncid/usr/share/man/man1/*2ncid.1 \
       debian/tmp-ncid/usr/share/man/man1/wct.1 \
       debian/tmp-gateways/usr/share/man/man1
	mv debian/tmp-ncid/usr/share/man/man5/*2ncid.conf.5 \
       debian/tmp-gateways/usr/share/man/man5
	mv debian/tmp-ncid/usr/share/man/man7/ncidgateways.7 \
       debian/tmp-gateways/usr/share/man/man7/.
	mv debian/tmp-ncid/usr/share/man/man8/sip2ncid.8 \
       debian/tmp-gateways/usr/share/man/man8/.
	install -m 644 man/ncid-email2ncid-setup.1 \
                   debian/tmp-gateways/usr/share/man/man1
	mv debian/tmp-ncid/etc/init.d/*2ncid debian/tmp-gateways/etc/init.d
	install -m 644 VERSION gateway/README.gateways \
                   debian/tmp-gateways/usr/share/doc/ncid-gateways
	dpkg-shlibdeps debian/tmp-gateways/usr/bin/ncid2ncid \
                   debian/tmp-gateways/usr/sbin/sip2ncid

        # NCID client and base output modules
	install -m 755 debian/postinst debian/tmp-client/DEBIAN
	install -m 755 debian/prerm-client debian/tmp-client/DEBIAN/prerm
	install -m 755 debian/postrm-client debian/tmp-client/DEBIAN/postrm
	install -m 644 debian/ncid-client.conffiles debian/tmp-client/DEBIAN/conffiles
	cd debian/tmp-client; mkdir -p etc/init.d etc/ncid/conf.d usr/bin \
       usr/share/ncid/modules usr/share/man/man1 usr/share/man/man5
	mkdir -p debian/tmp-client/usr/share/pixmaps/ncid
	install -m 755 client/ncid debian/tmp-client/usr/bin
	install -m 644 client/ncid.gif debian/tmp-client/usr/share/pixmaps/ncid
	install -m 644 client/ncid.conf debian/tmp-client/etc/ncid
	cd modules; install -m 644 ncid-notify.conf ncid-page.conf ncid-skel.conf \
                   ncid-alert.conf ncid-yac.conf \
                   ../debian/tmp-client/etc/ncid/conf.d
	cd modules; install -m 755 ncid-initmodem ncid-notify ncid-page \
                               ncid-alert ncid-wakeup ncid-skel ncid-yac \
                               ../debian/tmp-client/usr/share/ncid/modules
	install -m 644 README VERSION client/README.client modules/README.modules \
                   debian/tmp-client/usr/share/doc/ncid-client/.
	cd debian; install -m 755 ncid-initmodem ncid-notify ncid-page ncid-yac \
                              ../debian/tmp-client/etc/init.d
	cd man; install -m 644 ncid.1 ncid-initmodem.1 ncid-notify.1 \
                           ncid-page.1 ncid-skel.1 ncid-wakeup.1 ncid-yac.1 \
                           ncid-alert.1 ncid-modules.7 \
                           ../debian/tmp-client/usr/share/man/man1
	install -m 644 man/ncid.conf.5 debian/tmp-client/usr/share/man/man5

        # NCID client KDE popup module
	install -m 755 debian/postinst debian/tmp-kpopup/DEBIAN
	install -m 644 debian/ncid-kpopup.conffiles debian/tmp-kpopup/DEBIAN/conffiles
	cd debian/tmp-kpopup; mkdir -p etc/ncid/conf.d \
                   usr/share/ncid/modules usr/share/man/man1
	install -m 644 VERSION modules/README.modules \
                   debian/tmp-kpopup/usr/share/doc/ncid-kpopup
	install -m 755 modules/ncid-kpopup debian/tmp-kpopup/usr/share/ncid/modules/.
	install -m 755 modules/ncid-kpopup.conf debian/tmp-kpopup/etc/ncid/conf.d
	install -m 644 man/ncid-kpopup.1 debian/tmp-kpopup/usr/share/man/man1

        # NCID client MySQL module
	install -m 755 debian/postinst debian/tmp-mysql/DEBIAN
	install -m 755 debian/prerm-mysql debian/tmp-mysql/DEBIAN/prerm
	install -m 755 debian/postrm-mysql debian/tmp-mysql/DEBIAN/postrm
	install -m 644 debian/ncid-mysql.conffiles debian/tmp-mysql/DEBIAN/conffiles
	cd debian/tmp-mysql; mkdir -p etc/init.d usr/sbin etc/ncid/conf.d \
                   usr/share/ncid/modules usr/share/ncid/setup \
                   usr/share/man/man1 usr/share/man/man8
	install -m 755 setup/ncid-mysql-setup \
                   debian/tmp-mysql/usr/share/ncid/setup/.
	install -m 644 VERSION modules/README.modules setup/README.setup \
                   debian/tmp-mysql/usr/share/doc/ncid-mysql
	install -m 755 modules/ncid-mysql debian/tmp-mysql/usr/share/ncid/modules/.
	install -m 755 modules/ncid-mysql.conf debian/tmp-mysql/etc/ncid/conf.d
	install -m 755 debian/ncid-mysql debian/tmp-mysql/etc/init.d/.
	install -m 644 man/ncid-mysql.1 debian/tmp-mysql/usr/share/man/man1
	install -m 644 man/ncid-mysql-setup.8 debian/tmp-mysql/usr/share/man/man8

        # NCID client MythTV module
	install -m 755 debian/postinst debian/tmp-mythtv/DEBIAN
	install -m 755 debian/prerm-mythtv debian/tmp-mythtv/DEBIAN/prerm
	install -m 755 debian/postrm-mythtv debian/tmp-mythtv/DEBIAN/postrm
	install -m 644 debian/ncid-mythtv.conffiles debian/tmp-mythtv/DEBIAN/conffiles
	cd debian/tmp-mythtv; mkdir -p etc/init.d etc/ncid/conf.d \
                   usr/share/ncid/modules usr/share/man/man1 usr/share/man/man1
	install -m 644 VERSION modules/README.modules \
                   debian/tmp-mythtv/usr/share/doc/ncid-mythtv
	install -m 755 modules/ncid-mythtv debian/tmp-mythtv/usr/share/ncid/modules/.
	install -m 755 modules/ncid-mythtv.conf debian/tmp-mythtv/etc/ncid/conf.d
	install -m 755 debian/ncid-mythtv debian/tmp-mythtv/etc/init.d/.
	install -m 644 man/ncid-mythtv.1 debian/tmp-mythtv/usr/share/man/man1

        # NCID client samba module
	install -m 755 debian/postinst debian/tmp-samba/DEBIAN
	install -m 755 debian/prerm-samba debian/tmp-samba/DEBIAN/prerm
	install -m 755 debian/postrm-samba debian/tmp-samba/DEBIAN/postrm
	install -m 644 debian/ncid-samba.conffiles debian/tmp-samba/DEBIAN/conffiles
	cd debian/tmp-samba; mkdir -p etc/init.d etc/ncid/conf.d \
                   usr/share/ncid/modules usr/share/man/man1
	install -m 644 VERSION modules/README.modules \
                   debian/tmp-samba/usr/share/doc/ncid-samba
	install -m 755 modules/ncid-samba debian/tmp-samba/usr/share/ncid/modules/.
	install -m 755 modules/ncid-samba.conf debian/tmp-samba/etc/ncid/conf.d
	install -m 755 debian/ncid-samba debian/tmp-samba/etc/init.d/.
	install -m 644 man/ncid-samba.1 debian/tmp-samba/usr/share/man/man1

        # NCID client speak module
	install -m 755 debian/postinst debian/tmp-speak/DEBIAN
	install -m 755 debian/prerm-speak debian/tmp-speak/DEBIAN/prerm
	install -m 755 debian/postrm-speak debian/tmp-speak/DEBIAN/postrm
	install -m 644 debian/ncid-speak.conffiles debian/tmp-speak/DEBIAN/conffiles
	cd debian/tmp-speak; mkdir -p etc/init.d etc/ncid/conf.d \
                   usr/share/ncid/modules usr/share/man/man1
	install -m 644 VERSION modules/README.modules \
                   debian/tmp-speak/usr/share/doc/ncid-speak
	install -m 755 modules/ncid-speak debian/tmp-speak/usr/share/ncid/modules/.
	install -m 755 modules/ncid-speak.conf debian/tmp-speak/etc/ncid/conf.d
	install -m 755 debian/ncid-speak debian/tmp-speak/etc/init.d/.
	install -m 644 man/ncid-speak.1 debian/tmp-speak/usr/share/man/man1

        # cleanup and build packages
	gzip -r9 debian/tmp-ncid/usr/share/man debian/tmp-client/usr/share/man
	for i in $(package) $(pkg); do \
        if [ $$i = "ncid" ] ; then \
            dpkg-gencontrol -Pdebian/tmp-$$i -pncid -O | \
              sed 's/, libpcap.*)//' > debian/tmp-$$i/DEBIAN/control; \
        elif [ $$i = "gateways" ] ; then \
            dpkg-gencontrol -Pdebian/tmp-$$i -pncid-$$i; \
        else dpkg-gencontrol -Pdebian/tmp-$$i -pncid-$$i -O | \
              sed 's/lib.*), //' > debian/tmp-$$i/DEBIAN/control; \
        fi; \
        find debian/tmp-$$i -name \*CVS -print | xargs rm -fr; \
        chmod -R u+w,go=rX debian/tmp-$$i; \
        chown -R root:root debian/tmp-$$i; \
        dpkg --build debian/tmp-$$i ..; \
        done

define checkdir
	test -f server/$(prog).c -a -f debian/rules
endef

binary: binary-indep binary-arch

checkroot:
	$(checkdir)
	test $$(id -u) = 0

.PHONY: binary binary-arch binary-indep clean checkroot
